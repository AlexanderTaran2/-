<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdvancedPromise Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .demo-section {
            margin: 25px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        h3 {
            color: #444;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
            margin-top: 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            background: #e9ecef;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .progress {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-item {
            background: white;
            padding: 12px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #ddd;
            font-weight: bold;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .code-example {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .step-indicator {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Advanced JavaScript Patterns Demo</h1>
        
        <!-- –ó–∞–¥–∞–Ω–∏–µ 1: AdvancedPromise -->
        <div class="demo-section">
            <h3>1. AdvancedPromise - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ Promise-–ø–∞—Ç—Ç–µ—Ä–Ω—ã</h3>
            <p>–ö–ª–∞—Å—Å —Å –º–µ—Ç–æ–¥–∞–º–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫, —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥—è–º–∏</p>
            
            <div class="controls">
                <button onclick="testRetry()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å retry()</button>
                <button onclick="testTimeout()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å timeout()</button>
                <button onclick="testQueue()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å queue()</button>
                <button onclick="testCombined()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏—é</button>
            </div>
            
            <div id="retry-result" class="result"></div>
            <div id="timeout-result" class="result"></div>
            <div id="queue-result" class="result"></div>
            <div id="combined-result" class="result"></div>
        </div>

        <!-- –ó–∞–¥–∞–Ω–∏–µ 2: processDataAsync -->
        <div class="demo-section">
            <h3>2. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö (processDataAsync)</h3>
            <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–∏–≤–∞ –¥–∞–Ω–Ω—ã—Ö —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞, –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø–∞—É–∑–æ–π</p>
            
            <div class="controls">
                <button onclick="startProcessing()" id="start-btn">–ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</button>
                <button onclick="pauseProcessing()" id="pause-btn" disabled>–ü–∞—É–∑–∞</button>
                <button onclick="resumeProcessing()" id="resume-btn" disabled>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                <button onclick="stopProcessing()" id="stop-btn" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>

            <div class="stats" id="processing-stats">
                <div class="stat-item">–í—Å–µ–≥–æ: <span id="stat-total">0</span></div>
                <div class="stat-item">–£—Å–ø–µ—à–Ω–æ: <span id="stat-successful">0</span></div>
                <div class="stat-item">–û—à–∏–±–∫–∏: <span id="stat-failed">0</span></div>
                <div class="stat-item">–ü–æ–≤—Ç–æ—Ä—ã: <span id="stat-retries">0</span></div>
                <div class="stat-item">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="stat-progress">0%</span></div>
            </div>

            <div id="processing-result" class="result"></div>
        </div>

        <!-- –ó–∞–¥–∞–Ω–∏–µ 3: AsyncPipeline -->
        <div class="demo-section">
            <h3>3. AsyncPipeline - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –ø–∞–π–ø–ª–∞–π–Ω—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>
            <p>–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º –∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º</p>
            
            <div class="code-example">
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–π–ø–ª–∞–π–Ω–∞<br>
const pipeline = new AsyncPipeline()<br>
    .addStep(async (data) => data.filter(x => x > 0))<br>
    .addStep(async (data) => data.map(x => x * 2))<br>
    .addStep(async (data) => data.reduce((a, b) => a + b, 0));<br>
<br>
const result = await pipeline.execute([-1, 2, -3, 4, 5]);<br>
// –†–µ–∑—É–ª—å—Ç–∞—Ç: 22
            </div>
            
            <div class="controls">
                <button onclick="testBasicPipeline()">–ë–∞–∑–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω</button>
                <button onclick="testPipelineWithRetry()">–ü–∞–π–ø–ª–∞–π–Ω —Å retry</button>
                <button onclick="testPipelineWithTimeout()">–ü–∞–π–ø–ª–∞–π–Ω —Å —Ç–∞–π–º–∞—É—Ç–æ–º</button>
                <button onclick="testParallelPipelines()">–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ø–∞–π–ø–ª–∞–π–Ω—ã</button>
                <button onclick="testComplexPipeline()">–°–ª–æ–∂–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω</button>
            </div>

            <div id="pipeline-result" class="result"></div>
        </div>
    </div>

    <script>
        // ==================== –ó–ê–î–ê–ù–ò–ï 1: AdvancedPromise ====================
        class AdvancedPromise {
            static retry(promiseFn, maxAttempts = 3, delay = 1000) {
                return new Promise((resolve, reject) => {
                    const attempt = (attemptNumber) => {
                        promiseFn()
                            .then(resolve)
                            .catch((error) => {
                                if (attemptNumber >= maxAttempts) {
                                    reject(error);
                                } else {
                                    const nextDelay = delay * Math.pow(2, attemptNumber - 1);
                                    console.log(`–ü–æ–ø—ã—Ç–∫–∞ ${attemptNumber} –Ω–µ —É–¥–∞–ª–∞—Å—å. –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ ${nextDelay}–º—Å`);
                                    setTimeout(() => attempt(attemptNumber + 1), nextDelay);
                                }
                            });
                    };
                    attempt(1);
                });
            }

            static timeout(promise, ms) {
                return new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        reject(new Error(`–¢–∞–π–º–∞—É—Ç: –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ ${ms}–º—Å`));
                    }, ms);

                    promise
                        .then((result) => {
                            clearTimeout(timeoutId);
                            resolve(result);
                        })
                        .catch((error) => {
                            clearTimeout(timeoutId);
                            reject(error);
                        });
                });
            }

            static queue(tasks, concurrency = 1) {
                return new Promise((resolve) => {
                    const results = [];
                    let index = 0;
                    let running = 0;
                    let completed = 0;

                    const runNext = () => {
                        while (running < concurrency && index < tasks.length) {
                            const currentIndex = index++;
                            running++;
                            
                            tasks[currentIndex]()
                                .then((result) => {
                                    results[currentIndex] = { status: 'fulfilled', value: result };
                                })
                                .catch((error) => {
                                    results[currentIndex] = { status: 'rejected', reason: error };
                                })
                                .finally(() => {
                                    running--;
                                    completed++;
                                    
                                    if (completed === tasks.length) {
                                        resolve(results);
                                    } else {
                                        runNext();
                                    }
                                });
                        }
                    };

                    runNext();
                });
            }
        }

        // ==================== –ó–ê–î–ê–ù–ò–ï 2: DataProcessor ====================
        class DataProcessor {
            constructor(data, processorFn, options = {}) {
                this.data = data;
                this.processorFn = processorFn;
                this.concurrency = options.concurrency || 1;
                this.retryAttempts = options.retryAttempts || 0;
                this.delay = options.delay || 0;
                
                this.results = [];
                this.stats = {
                    total: data.length,
                    successful: 0,
                    failed: 0,
                    retries: 0
                };
                
                this.currentIndex = 0;
                this.running = 0;
                this.isPaused = false;
                this.resolve = null;
                this.reject = null;
                this.isStopped = false;
            }

            async processWithRetry(item, index, attempts = 0) {
                if (this.isStopped) return;

                try {
                    const result = await this.processorFn(item, index);
                    this.results[index] = { status: 'fulfilled', value: result };
                    this.stats.successful++;
                    this.updateStats();
                    return result;
                } catch (error) {
                    if (attempts < this.retryAttempts && !this.isStopped) {
                        this.stats.retries++;
                        this.updateStats();
                        console.log(`–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞ ${item} (–ø–æ–ø—ã—Ç–∫–∞ ${attempts + 1})`);
                        await this.delayPromise(this.delay);
                        return this.processWithRetry(item, index, attempts + 1);
                    } else {
                        this.results[index] = { status: 'rejected', reason: error };
                        this.stats.failed++;
                        this.updateStats();
                        throw error;
                    }
                }
            }

            delayPromise(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            async processItem() {
                if (this.currentIndex >= this.data.length || this.isPaused || this.isStopped) {
                    return;
                }

                const index = this.currentIndex++;
                const item = this.data[index];
                this.running++;

                try {
                    await this.processWithRetry(item, index);
                } catch (error) {
                    // –û—à–∏–±–∫–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –≤ processWithRetry
                } finally {
                    this.running--;
                    if (!this.isStopped) {
                        this.processNext();
                    }
                }
            }

            processNext() {
                while (this.running < this.concurrency && 
                       this.currentIndex < this.data.length && 
                       !this.isPaused && 
                       !this.isStopped) {
                    this.processItem();
                }

                if (this.running === 0 && 
                    this.currentIndex >= this.data.length && 
                    this.resolve) {
                    this.resolve({
                        results: this.results,
                        stats: this.stats
                    });
                }
            }

            pause() {
                this.isPaused = true;
            }

            resume() {
                if (this.isPaused && !this.isStopped) {
                    this.isPaused = false;
                    this.processNext();
                }
            }

            stop() {
                this.isStopped = true;
                this.isPaused = false;
            }

            updateStats() {
                const progress = ((this.stats.successful + this.stats.failed) / this.stats.total * 100).toFixed(1);
                
                document.getElementById('stat-total').textContent = this.stats.total;
                document.getElementById('stat-successful').textContent = this.stats.successful;
                document.getElementById('stat-failed').textContent = this.stats.failed;
                document.getElementById('stat-retries').textContent = this.stats.retries;
                document.getElementById('stat-progress').textContent = progress + '%';
            }

            async start() {
                return new Promise((resolve, reject) => {
                    this.resolve = resolve;
                    this.reject = reject;
                    this.processNext();
                });
            }
        }

        async function processDataAsync(data, processorFn, options = {}) {
            const processor = new DataProcessor(data, processorFn, options);
            return processor.start();
        }

        // ==================== –ó–ê–î–ê–ù–ò–ï 3: AsyncPipeline ====================
        class AsyncPipeline {
            constructor() {
                this.steps = [];
            }
            
            addStep(stepFn) {
                this.steps.push(stepFn);
                return this; // –î–ª—è —á–µ–π–Ω–∏–Ω–≥–∞
            }
            
            async execute(input) {
                let result = input;
                let stepNumber = 1;
                
                for (const step of this.steps) {
                    console.log(`–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —à–∞–≥–∞ ${stepNumber} —Å –¥–∞–Ω–Ω—ã–º–∏:`, result);
                    result = await step(result);
                    console.log(`–®–∞–≥ ${stepNumber} –∑–∞–≤–µ—Ä—à–µ–Ω. –†–µ–∑—É–ª—å—Ç–∞—Ç:`, result);
                    stepNumber++;
                }
                return result;
            }
            
            static async parallel(pipelines, input) {
                const results = await Promise.all(
                    pipelines.map((pipeline, index) => 
                        pipeline.execute(input).then(result => ({ pipeline: index, result }))
                    )
                );
                return results;
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
            withTimeout(ms) {
                const originalExecute = this.execute.bind(this);
                this.execute = async (input) => {
                    return AdvancedPromise.timeout(originalExecute(input), ms);
                };
                return this;
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
            withRetry(maxAttempts = 3, delay = 1000) {
                const originalExecute = this.execute.bind(this);
                this.execute = async (input) => {
                    return AdvancedPromise.retry(() => originalExecute(input), maxAttempts, delay);
                };
                return this;
            }
        }

        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let currentProcessor = null;

        // ==================== –¢–ï–°–¢–´ –î–õ–Ø PIPELINE ====================
        async function testBasicPipeline() {
            const resultDiv = document.getElementById('pipeline-result');
            resultDiv.innerHTML = 'üîÑ –ó–∞–ø—É—Å–∫ –±–∞–∑–æ–≤–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞...';
            resultDiv.className = 'result progress';

            try {
                const pipeline = new AsyncPipeline()
                    .addStep(async (data) => {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        return data.filter(x => x > 0);
                    })
                    .addStep(async (data) => {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        return data.map(x => x * 2);
                    })
                    .addStep(async (data) => {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        return data.reduce((a, b) => a + b, 0);
                    });

                const result = await pipeline.execute([-1, 2, -3, 4, 5]);
                
                resultDiv.innerHTML = `‚úÖ –ë–∞–∑–æ–≤—ã–π –ø–∞–π–ø–ª–∞–π–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!\n\n` +
                    `–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: [-1, 2, -3, 4, 5]\n` +
                    `–®–∞–≥ 1: filter(x => x > 0) ‚Üí [2, 4, 5]\n` +
                    `–®–∞–≥ 2: map(x => x * 2) ‚Üí [4, 8, 10]\n` +
                    `–®–∞–≥ 3: reduce((a, b) => a + b, 0) ‚Üí 22\n\n` +
                    `üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${result}`;
                resultDiv.classList.add('success');
            } catch (error) {
                resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ: ${error.message}`;
                resultDiv.classList.add('error');
            }
        }

        async function testPipelineWithRetry() {
            const resultDiv = document.getElementById('pipeline-result');
            resultDiv.innerHTML = 'üîÑ –ó–∞–ø—É—Å–∫ –ø–∞–π–ø–ª–∞–π–Ω–∞ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏...';
            resultDiv.className = 'result progress';

            let attemptCount = 0;

            try {
                const pipeline = new AsyncPipeline()
                    .addStep(async (data) => {
                        attemptCount++;
                        await new Promise(resolve => setTimeout(resolve, 200));
                        // –ò–º–∏—Ç–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –æ—à–∏–±–æ–∫
                        if (attemptCount < 3 && Math.random() < 0.7) {
                            throw new Error(`–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –Ω–∞ —à–∞–≥–µ 1 (–ø–æ–ø—ã—Ç–∫–∞ ${attemptCount})`);
                        }
                        return data.map(x => x * x);
                    })
                    .addStep(async (data) => {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        return data.filter(x => x % 2 === 0);
                    })
                    .withRetry(3, 500); // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏

                const result = await pipeline.execute([1, 2, 3, 4, 5]);
                
                resultDiv.innerHTML = `‚úÖ –ü–∞–π–ø–ª–∞–π–Ω —Å retry –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!\n\n` +
                    `–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫: ${attemptCount}\n` +
                    `–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: [1, 2, 3, 4, 5]\n` +
                    `–®–∞–≥ 1: map(x => x * x) ‚Üí [1, 4, 9, 16, 25]\n` +
                    `–®–∞–≥ 2: filter(x => x % 2 === 0) ‚Üí [4, 16]\n\n` +
                    `üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: [${result.join(', ')}]`;
                resultDiv.classList.add('success');
            } catch (error) {
                resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ: ${error.message}\n\n` +
                    `–í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫: ${attemptCount}`;
                resultDiv.classList.add('error');
            }
        }

        async function testPipelineWithTimeout() {
            const resultDiv = document.getElementById('pipeline-result');
            resultDiv.innerHTML = 'üîÑ –ó–∞–ø—É—Å–∫ –ø–∞–π–ø–ª–∞–π–Ω–∞ —Å —Ç–∞–π–º–∞—É—Ç–æ–º...';
            resultDiv.className = 'result progress';

            try {
                const pipeline = new AsyncPipeline()
                    .addStep(async (data) => {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return data.toUpperCase();
                    })
                    .addStep(async (data) => {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return data.split('').reverse().join('');
                    })
                    .withTimeout(1500); // –¢–∞–π–º–∞—É—Ç –º–µ–Ω—å—à–µ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

                const result = await pipeline.execute('hello');
                
                resultDiv.innerHTML = `‚úÖ –ü–∞–π–ø–ª–∞–π–Ω —Å —Ç–∞–π–º–∞—É—Ç–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!\n\n` +
                    `–†–µ–∑—É–ª—å—Ç–∞—Ç: ${result}`;
                resultDiv.classList.add('success');
            } catch (error) {
                resultDiv.innerHTML = `‚ùå –¢–∞–π–º–∞—É—Ç –ø–∞–π–ø–ª–∞–π–Ω–∞: ${error.message}\n\n` +
                    `–ü–∞–π–ø–ª–∞–π–Ω –±—ã–ª –ø—Ä–µ—Ä–≤–∞–Ω –∏–∑-–∑–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è`;
                resultDiv.classList.add('error');
            }
        }

        async function testParallelPipelines() {
            const resultDiv = document.getElementById('pipeline-result');
            resultDiv.innerHTML = 'üîÑ –ó–∞–ø—É—Å–∫ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤...';
            resultDiv.className = 'result progress';

            try {
                // –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤
                const pipeline1 = new AsyncPipeline()
                    .addStep(async (data) => data.filter(x => x % 2 === 0))
                    .addStep(async (data) => data.map(x => x * 10));

                const pipeline2 = new AsyncPipeline()
                    .addStep(async (data) => data.filter(x => x % 2 !== 0))
                    .addStep(async (data) => data.map(x => x * 5));

                const pipeline3 = new AsyncPipeline()
                    .addStep(async (data) => data.map(x => x * x))
                    .addStep(async (data) => data.filter(x => x > 10));

                const pipelines = [pipeline1, pipeline2, pipeline3];
                const input = [1, 2, 3, 4, 5, 6, 7, 8];

                const results = await AsyncPipeline.parallel(pipelines, input);
                
                let output = `‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ø–∞–π–ø–ª–∞–π–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!\n\n`;
                output += `–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: [${input.join(', ')}]\n\n`;
                
                results.forEach((result, index) => {
                    output += `–ü–∞–π–ø–ª–∞–π–Ω ${index + 1}: [${result.result.join(', ')}]\n`;
                });
                
                output += `\nüéØ –í—Å–µ –ø–∞–π–ø–ª–∞–π–Ω—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ`;
                resultDiv.innerHTML = output;
                resultDiv.classList.add('success');
            } catch (error) {
                resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–∞–π–ø–ª–∞–π–Ω–∞—Ö: ${error.message}`;
                resultDiv.classList.add('error');
            }
        }

        async function testComplexPipeline() {
            const resultDiv = document.getElementById('pipeline-result');
            resultDiv.innerHTML = 'üîÑ –ó–∞–ø—É—Å–∫ —Å–ª–æ–∂–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞...';
            resultDiv.className = 'result progress';

            try {
                const pipeline = new AsyncPipeline()
                    .addStep(async (data) => {
                        await new Promise(resolve => setTimeout(resolve, 300));
                        return data.split('').reverse().join('');
                    })
                    .addStep(async (data) => {
                        await new Promise(resolve => setTimeout(resolve, 200));
                        return data.toUpperCase();
                    })
                    .addStep(async (data) => {
                        await new Promise(resolve => setTimeout(resolve, 400));
                        return data + '!';
                    })
                    .addStep(async (data) => {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        return `–†–µ–∑—É–ª—å—Ç–∞—Ç: "${data}" (–¥–ª–∏–Ω–∞: ${data.length})`;
                    })
                    .withRetry(2, 300)
                    .withTimeout(3000);

                const result = await pipeline.execute('javascript');
                
                resultDiv.innerHTML = `‚úÖ –°–ª–æ–∂–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!\n\n` +
                    `–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: "javascript"\n` +
                    `–®–∞–≥ 1: reverse() ‚Üí "tpircsavaj"\n` +
                    `–®–∞–≥ 2: toUpperCase() ‚Üí "TPIRCSAVAJ"\n` +
                    `–®–∞–≥ 3: add '!' ‚Üí "TPIRCSAVAJ!"\n` +
                    `–®–∞–≥ 4: format result ‚Üí "${result}"\n\n` +
                    `üéØ –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${result}`;
                resultDiv.classList.add('success');
            } catch (error) {
                resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –≤ —Å–ª–æ–∂–Ω–æ–º –ø–∞–π–ø–ª–∞–π–Ω–µ: ${error.message}`;
                resultDiv.classList.add('error');
            }
        }

        // ==================== –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –§–£–ù–ö–¶–ò–ò (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ====================
        async function startProcessing() {
            const resultDiv = document.getElementById('processing-result');
            resultDiv.innerHTML = '–ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö...';
            resultDiv.className = 'result progress';

            document.getElementById('start-btn').disabled = true;
            document.getElementById('pause-btn').disabled = false;
            document.getElementById('stop-btn').disabled = false;
            document.getElementById('resume-btn').disabled = true;

            const testData = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            
            const processorFn = async (num, index) => {
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (Math.random() < 0.3 && num % 3 !== 0) {
                    throw new Error(`–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–ª—è —á–∏—Å–ª–∞ ${num}`);
                }
                
                return { 
                    original: num, 
                    processed: num * 2,
                    timestamp: new Date().toLocaleTimeString()
                };
            };

            const options = {
                concurrency: 2,
                retryAttempts: 2,
                delay: 1000
            };

            try {
                currentProcessor = new DataProcessor(testData, processorFn, options);
                const result = await currentProcessor.start();
                
                resultDiv.innerHTML = `‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n` +
                    `–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n` +
                    `- –í—Å–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ${result.stats.total}\n` +
                    `- –£—Å–ø–µ—à–Ω–æ: ${result.stats.successful}\n` +
                    `- –û—à–∏–±–∫–∏: ${result.stats.failed}\n` +
                    `- –ü–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫: ${result.stats.retries}\n\n` +
                    `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:\n${JSON.stringify(result.results, null, 2)}`;
                resultDiv.classList.add('success');
                
            } catch (error) {
                resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${error.message}`;
                resultDiv.classList.add('error');
            } finally {
                document.getElementById('start-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('resume-btn').disabled = true;
                document.getElementById('stop-btn').disabled = true;
                currentProcessor = null;
            }
        }

        function pauseProcessing() {
            if (currentProcessor) {
                currentProcessor.pause();
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('resume-btn').disabled = false;
                document.getElementById('processing-result').innerHTML += '\n‚è∏Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
            }
        }

        function resumeProcessing() {
            if (currentProcessor) {
                currentProcessor.resume();
                document.getElementById('pause-btn').disabled = false;
                document.getElementById('resume-btn').disabled = true;
                document.getElementById('processing-result').innerHTML += '\n‚ñ∂Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∞';
            }
        }

        function stopProcessing() {
            if (currentProcessor) {
                currentProcessor.stop();
                document.getElementById('start-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('resume-btn').disabled = true;
                document.getElementById('stop-btn').disabled = true;
                document.getElementById('processing-result').innerHTML += '\nüõë –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
                currentProcessor = null;
            }
        }

        function testRetry() {
            const resultDiv = document.getElementById('retry-result');
            resultDiv.innerHTML = '–ó–∞–ø—É—Å–∫ retry...';
            resultDiv.className = 'result';

            let attemptCount = 0;
            
            AdvancedPromise.retry(
                () => {
                    attemptCount++;
                    console.log(`–ü–æ–ø—ã—Ç–∫–∞ ${attemptCount}`);
                    
                    return new Promise((resolve, reject) => {
                        setTimeout(() => {
                            if (attemptCount < 2) {
                                reject(new Error(`–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–ø–æ–ø—ã—Ç–∫–∞ ${attemptCount})`));
                            } else {
                                resolve({ data: '–£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ ' + attemptCount + ' –ø–æ–ø—ã—Ç–æ–∫' });
                            }
                        }, 500);
                    });
                },
                3,
                1000
            )
            .then(result => {
                resultDiv.innerHTML = `‚úÖ –£—Å–ø–µ—Ö: ${JSON.stringify(result, null, 2)}`;
                resultDiv.classList.add('success');
            })
            .catch(error => {
                resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                resultDiv.classList.add('error');
            });
        }

        function testTimeout() {
            const resultDiv = document.getElementById('timeout-result');
            resultDiv.innerHTML = '–ó–∞–ø—É—Å–∫ timeout...';
            resultDiv.className = 'result';

            const slowPromise = new Promise(resolve => {
                setTimeout(() => resolve('–ú–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç'), 3000);
            });

            AdvancedPromise.timeout(slowPromise, 2000)
                .then(result => {
                    resultDiv.innerHTML = `‚úÖ –£—Å–ø–µ—Ö: ${result}`;
                    resultDiv.classList.add('success');
                })
                .catch(error => {
                    resultDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                    resultDiv.classList.add('error');
                });
        }

        function testQueue() {
            const resultDiv = document.getElementById('queue-result');
            resultDiv.innerHTML = '–ó–∞–ø—É—Å–∫ queue...';
            resultDiv.className = 'result';

            const tasks = [
                () => new Promise(resolve => setTimeout(() => resolve('–ó–∞–¥–∞—á–∞ 1'), 1000)),
                () => new Promise(resolve => setTimeout(() => resolve('–ó–∞–¥–∞—á–∞ 2'), 800)),
                () => new Promise(resolve => setTimeout(() => resolve('–ó–∞–¥–∞—á–∞ 3'), 600)),
                () => new Promise(resolve => setTimeout(() => resolve('–ó–∞–¥–∞—á–∞ 4'), 1200)),
                () => new Promise((_, reject) => setTimeout(() => reject('–û—à–∏–±–∫–∞ –≤ –∑–∞–¥–∞—á–µ 5'), 500))
            ];

            AdvancedPromise.queue(tasks, 2)
                .then(results => {
                    resultDiv.innerHTML = '‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–µ—Ä–µ–¥–∏:\n' + 
                        results.map((r, i) => `–ó–∞–¥–∞—á–∞ ${i + 1}: ${JSON.stringify(r)}`).join('\n');
                    resultDiv.classList.add('success');
                });
        }

        function testCombined() {
            const resultDiv = document.getElementById('combined-result');
            resultDiv.innerHTML = '–ó–∞–ø—É—Å–∫ retry + timeout...';
            resultDiv.className = 'result';

            let attemptCount = 0;
            
            const promiseWithRetry = AdvancedPromise.retry(
                () => {
                    attemptCount++;
                    console.log(`–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ${attemptCount}`);
                    
                    return new Promise((resolve, reject) => {
                        setTimeout(() => {
                            if (attemptCount < 2) {
                                reject(new Error('–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞'));
                            } else {
                                resolve('–£—Å–ø–µ—Ö –ø–æ—Å–ª–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫!');
                            }
                        }, 1500);
                    });
                },
                3,
                500
            );

            AdvancedPromise.timeout(promiseWithRetry, 4000)
                .then(result => {
                    resultDiv.innerHTML = `‚úÖ –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—Å–ø–µ—Ö: ${result}`;
                    resultDiv.classList.add('success');
                })
                .catch(error => {
                    resultDiv.innerHTML = `‚ùå –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: ${error.message}`;
                    resultDiv.classList.add('error');
                });
        }
    </script>
</body>
</html>